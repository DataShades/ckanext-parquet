var hyparquet=(()=>{var ee=Object.defineProperty;var tt=Object.getOwnPropertyDescriptor;var nt=Object.getOwnPropertyNames;var rt=Object.prototype.hasOwnProperty;var it=(e,t)=>{for(var n in t)ee(e,n,{get:t[n],enumerable:!0})},ot=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of nt(t))!rt.call(e,i)&&i!==n&&ee(e,i,{get:()=>t[i],enumerable:!(r=tt(t,i))||r.enumerable});return e};var ft=e=>ot(ee({},"__esModule",{value:!0}),e);var Dt={};it(Dt,{asyncBufferFromUrl:()=>$e,byteLengthFromUrl:()=>ue,cachedAsyncBuffer:()=>Ce,flatten:()=>x,parquetMetadata:()=>z,parquetMetadataAsync:()=>L,parquetQuery:()=>Xe,parquetRead:()=>ge,parquetReadObjects:()=>P,parquetSchema:()=>T,readColumnIndex:()=>Be,readOffsetIndex:()=>Ue,snappyUncompress:()=>K,toJson:()=>W});var te=["BOOLEAN","INT32","INT64","INT96","FLOAT","DOUBLE","BYTE_ARRAY","FIXED_LEN_BYTE_ARRAY"],v=["PLAIN","GROUP_VAR_INT","PLAIN_DICTIONARY","RLE","BIT_PACKED","DELTA_BINARY_PACKED","DELTA_LENGTH_BYTE_ARRAY","DELTA_BYTE_ARRAY","RLE_DICTIONARY","BYTE_STREAM_SPLIT"],we=["REQUIRED","OPTIONAL","REPEATED"],Ae=["UTF8","MAP","MAP_KEY_VALUE","LIST","ENUM","DECIMAL","DATE","TIME_MILLIS","TIME_MICROS","TIMESTAMP_MILLIS","TIMESTAMP_MICROS","UINT_8","UINT_16","UINT_32","UINT_64","INT_8","INT_16","INT_32","INT_64","JSON","BSON","INTERVAL"],Ee=["UNCOMPRESSED","SNAPPY","GZIP","LZO","BROTLI","LZ4","ZSTD","LZ4_RAW"],q=["DATA_PAGE","INDEX_PAGE","DICTIONARY_PAGE","DATA_PAGE_V2"],Ie=["UNORDERED","ASCENDING","DESCENDING"],ve=["SPHERICAL","VINCENTY","THOMAS","ANDOYER","KARNEY"];function k(e){let t=Y(e);if(t.type===1)return{type:"Point",coordinates:ne(e,t)};if(t.type===2)return{type:"LineString",coordinates:re(e,t)};if(t.type===3)return{type:"Polygon",coordinates:be(e,t)};if(t.type===4){let n=[];for(let r=0;r<t.count;r++)n.push(ne(e,Y(e)));return{type:"MultiPoint",coordinates:n}}else if(t.type===5){let n=[];for(let r=0;r<t.count;r++)n.push(re(e,Y(e)));return{type:"MultiLineString",coordinates:n}}else if(t.type===6){let n=[];for(let r=0;r<t.count;r++)n.push(be(e,Y(e)));return{type:"MultiPolygon",coordinates:n}}else if(t.type===7){let n=[];for(let r=0;r<t.count;r++)n.push(k(e));return{type:"GeometryCollection",geometries:n}}else throw new Error(`Unsupported geometry type: ${t.type}`)}function Y(e){let{view:t}=e,n=t.getUint8(e.offset++)===1,r=t.getUint32(e.offset,n);e.offset+=4;let i=r%1e3,o=Math.floor(r/1e3),f=0;i>1&&i<=7&&(f=t.getUint32(e.offset,n),e.offset+=4);let s=2;return o&&s++,o===3&&s++,{littleEndian:n,type:i,dim:s,count:f}}function ne(e,t){let n=[];for(let r=0;r<t.dim;r++){let i=e.view.getFloat64(e.offset,t.littleEndian);e.offset+=8,n.push(i)}return n}function re(e,t){let n=[];for(let r=0;r<t.count;r++)n.push(ne(e,t));return n}function be(e,t){let{view:n}=e,r=[];for(let i=0;i<t.count;i++){let o=n.getUint32(e.offset,t.littleEndian);e.offset+=4,r.push(re(e,{...t,count:o}))}return r}var Te=new TextDecoder,D={timestampFromMilliseconds(e){return new Date(Number(e))},timestampFromMicroseconds(e){return new Date(Number(e/1000n))},timestampFromNanoseconds(e){return new Date(Number(e/1000000n))},dateFromDays(e){return new Date(e*864e5)},stringFromBytes(e){return e&&Te.decode(e)},geometryFromBytes(e){return e&&k({view:new DataView(e.buffer,e.byteOffset,e.byteLength),offset:0})},geographyFromBytes(e){return e&&k({view:new DataView(e.buffer,e.byteOffset,e.byteLength),offset:0})}};function ie(e,t,n,r){if(t&&n.endsWith("_DICTIONARY")){let i=e;e instanceof Uint8Array&&!(t instanceof Uint8Array)&&(i=new t.constructor(e.length));for(let o=0;o<e.length;o++)i[o]=t[e[o]];return i}else return oe(e,r)}function oe(e,t){let{element:n,parsers:r,utf8:i=!0}=t,{type:o,converted_type:f,logical_type:s}=n;if(f==="DECIMAL"){let d=10**-(n.scale||0),c=new Array(e.length);for(let a=0;a<c.length;a++)e[a]instanceof Uint8Array?c[a]=fe(e[a])*d:c[a]=Number(e[a])*d;return c}if(!f&&o==="INT96")return Array.from(e).map(l=>r.timestampFromNanoseconds(st(l)));if(f==="DATE")return Array.from(e).map(l=>r.dateFromDays(l));if(f==="TIMESTAMP_MILLIS")return Array.from(e).map(l=>r.timestampFromMilliseconds(l));if(f==="TIMESTAMP_MICROS")return Array.from(e).map(l=>r.timestampFromMicroseconds(l));if(f==="JSON")return e.map(l=>JSON.parse(Te.decode(l)));if(f==="BSON")throw new Error("parquet bson not supported");if(f==="INTERVAL")throw new Error("parquet interval not supported");if(s?.type==="GEOMETRY")return e.map(l=>r.geometryFromBytes(l));if(s?.type==="GEOGRAPHY")return e.map(l=>r.geographyFromBytes(l));if(f==="UTF8"||s?.type==="STRING"||i&&o==="BYTE_ARRAY")return e.map(l=>r.stringFromBytes(l));if(f==="UINT_64"||s?.type==="INTEGER"&&s.bitWidth===64&&!s.isSigned){if(e instanceof BigInt64Array)return new BigUint64Array(e.buffer,e.byteOffset,e.length);let l=new BigUint64Array(e.length);for(let d=0;d<l.length;d++)l[d]=BigInt(e[d]);return l}if(f==="UINT_32"||s?.type==="INTEGER"&&s.bitWidth===32&&!s.isSigned){if(e instanceof Int32Array)return new Uint32Array(e.buffer,e.byteOffset,e.length);let l=new Uint32Array(e.length);for(let d=0;d<l.length;d++)l[d]=e[d];return l}if(s?.type==="FLOAT16")return Array.from(e).map(se);if(s?.type==="TIMESTAMP"){let{unit:l}=s,d=r.timestampFromMilliseconds;l==="MICROS"&&(d=r.timestampFromMicroseconds),l==="NANOS"&&(d=r.timestampFromNanoseconds);let c=new Array(e.length);for(let a=0;a<c.length;a++)c[a]=d(e[a]);return c}return e}function fe(e){if(!e.length)return 0;let t=0n;for(let r of e)t=t*256n+BigInt(r);let n=e.length*8;return t>=2n**BigInt(n-1)&&(t-=2n**BigInt(n)),Number(t)}function st(e){let t=(e>>64n)-2440588n,n=e&0xffffffffffffffffn;return t*86400000000000n+n}function se(e){if(!e)return;let t=e[1]<<8|e[0],n=t>>15?-1:1,r=t>>10&31,i=t&1023;return r===0?n*2**-14*(i/1024):r===31?i?NaN:n*(1/0):n*2**(r-15)*(1+i/1024)}function Re(e,t,n){let r=e[t],i=[],o=1;if(r.num_children)for(;i.length<r.num_children;){let f=e[t+o],s=Re(e,t+o,[...n,f.name]);o+=s.count,i.push(s)}return{count:o,element:r,children:i,path:n}}function G(e,t){let n=Re(e,0,[]),r=[n];for(let i of t){let o=n.children.find(f=>f.element.name===i);if(!o)throw new Error(`parquet schema element not found: ${t}`);r.push(o),n=o}return r}function Le(e){let t=[];function n(r){if(r.children.length)for(let i of r.children)n(i);else t.push(r.element.name)}return n(e),t}function le(e){let t=0;for(let{element:n}of e)n.repetition_type==="REPEATED"&&t++;return t}function M(e){let t=0;for(let{element:n}of e.slice(1))n.repetition_type!=="REQUIRED"&&t++;return t}function xe(e){if(!e||e.element.converted_type!=="LIST"||e.children.length>1)return!1;let t=e.children[0];return!(t.children.length>1||t.element.repetition_type!=="REPEATED")}function Ne(e){if(!e||e.element.converted_type!=="MAP"||e.children.length>1)return!1;let t=e.children[0];return!(t.children.length!==2||t.element.repetition_type!=="REPEATED"||t.children.find(i=>i.element.name==="key")?.element.repetition_type==="REPEATED"||t.children.find(i=>i.element.name==="value")?.element.repetition_type==="REPEATED")}function ae(e){if(e.length!==2)return!1;let[,t]=e;return!(t.element.repetition_type==="REPEATED"||t.children.length)}var A={STOP:0,TRUE:1,FALSE:2,BYTE:3,I16:4,I32:5,I64:6,DOUBLE:7,BINARY:8,LIST:9,SET:10,MAP:11,STRUCT:12,UUID:13};function N(e){let t=0,n={};for(;e.offset<e.view.byteLength;){let[r,i,o]=Se(e,t);if(t=o,r===A.STOP)break;n[`field_${i}`]=V(e,r)}return n}function V(e,t){switch(t){case A.TRUE:return!0;case A.FALSE:return!1;case A.BYTE:return e.view.getInt8(e.offset++);case A.I16:case A.I32:return Oe(e);case A.I64:return j(e);case A.DOUBLE:{let n=e.view.getFloat64(e.offset,!0);return e.offset+=8,n}case A.BINARY:{let n=b(e),r=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,n);return e.offset+=n,r}case A.LIST:{let n=e.view.getUint8(e.offset++),r=n&15,i=n>>4;i===15&&(i=b(e));let o=r===A.TRUE||r===A.FALSE,f=new Array(i);for(let s=0;s<i;s++)f[s]=o?V(e,A.BYTE)===1:V(e,r);return f}case A.STRUCT:{let n={},r=0;for(;;){let[i,o,f]=Se(e,r);if(r=f,i===A.STOP)break;n[`field_${o}`]=V(e,i)}return n}default:throw new Error(`thrift unhandled type: ${t}`)}}function b(e){let t=0,n=0;for(;;){let r=e.view.getUint8(e.offset++);if(t|=(r&127)<<n,!(r&128))return t;n+=7}}function lt(e){let t=0n,n=0n;for(;;){let r=e.view.getUint8(e.offset++);if(t|=BigInt(r&127)<<n,!(r&128))return t;n+=7n}}function Oe(e){let t=b(e);return t>>>1^-(t&1)}function j(e){let t=lt(e);return t>>1n^-(t&1n)}function Se(e,t){let n=e.view.getUint8(e.offset++),r=n&15;if(r===A.STOP)return[0,0,t];let i=n>>4,o=i?t+i:Oe(e);return[r,o,o]}function Pe(e,t){let n=new Map,r=t?.find(({key:o})=>o==="geo")?.value,i=(r&&JSON.parse(r)?.columns)??{};for(let[o,f]of Object.entries(i)){if(f.encoding!=="WKB")continue;let s=f.edges==="spherical"?"GEOGRAPHY":"GEOMETRY",l=f.crs?.id??f.crs?.ids?.[0],d=l?`${l.authority}:${l.code.toString()}`:void 0;n.set(o,{type:s,crs:d})}for(let o=1;o<e.length;o++){let f=e[o],{logical_type:s,name:l,num_children:d,repetition_type:c,type:a}=f;if(d){o+=d;continue}a==="BYTE_ARRAY"&&s===void 0&&c!=="REPEATED"&&(f.logical_type=n.get(l))}}var ce=1<<19,at=new TextDecoder;function E(e){return e&&at.decode(e)}async function L(e,{parsers:t,initialFetchSize:n=ce,geoparquet:r=!0}={}){if(!e||!(e.byteLength>=0))throw new Error("parquet expected AsyncBuffer");let i=Math.max(0,e.byteLength-n),o=await e.slice(i,e.byteLength),f=new DataView(o);if(f.getUint32(o.byteLength-4,!0)!==827474256)throw new Error("parquet file invalid (footer != PAR1)");let s=f.getUint32(o.byteLength-8,!0);if(s>e.byteLength-8)throw new Error(`parquet metadata length ${s} exceeds available buffer ${e.byteLength-8}`);if(s+8>n){let l=e.byteLength-s-8,d=await e.slice(l,i),c=new ArrayBuffer(s+8),a=new Uint8Array(c);return a.set(new Uint8Array(d)),a.set(new Uint8Array(o),i-l),z(c,{parsers:t,geoparquet:r})}else return z(o,{parsers:t,geoparquet:r})}function z(e,{parsers:t,geoparquet:n=!0}={}){if(!(e instanceof ArrayBuffer))throw new Error("parquet expected ArrayBuffer");let r=new DataView(e);if(t={...D,...t},r.byteLength<8)throw new Error("parquet file is too short");if(r.getUint32(r.byteLength-4,!0)!==827474256)throw new Error("parquet file invalid (footer != PAR1)");let i=r.byteLength-8,o=r.getUint32(i,!0);if(o>r.byteLength-8)throw new Error(`parquet metadata length ${o} exceeds available buffer ${r.byteLength-8}`);let f=i-o,l=N({view:r,offset:f}),d=l.field_1,c=l.field_2.map(h=>({type:te[h.field_1],type_length:h.field_2,repetition_type:we[h.field_3],name:E(h.field_4),num_children:h.field_5,converted_type:Ae[h.field_6],scale:h.field_7,precision:h.field_8,field_id:h.field_9,logical_type:ct(h.field_10)})),a=c.filter(h=>h.type),u=l.field_3,p=l.field_4.map(h=>({columns:h.field_1.map((_,g)=>({file_path:E(_.field_1),file_offset:_.field_2,meta_data:_.field_3&&{type:te[_.field_3.field_1],encodings:_.field_3.field_2?.map(w=>v[w]),path_in_schema:_.field_3.field_3.map(E),codec:Ee[_.field_3.field_4],num_values:_.field_3.field_5,total_uncompressed_size:_.field_3.field_6,total_compressed_size:_.field_3.field_7,key_value_metadata:_.field_3.field_8?.map(w=>({key:E(w.field_1),value:E(w.field_2)})),data_page_offset:_.field_3.field_9,index_page_offset:_.field_3.field_10,dictionary_page_offset:_.field_3.field_11,statistics:ut(_.field_3.field_12,a[g],t),encoding_stats:_.field_3.field_13?.map(w=>({page_type:q[w.field_1],encoding:v[w.field_2],count:w.field_3})),bloom_filter_offset:_.field_3.field_14,bloom_filter_length:_.field_3.field_15,size_statistics:_.field_3.field_16&&{unencoded_byte_array_data_bytes:_.field_3.field_16.field_1,repetition_level_histogram:_.field_3.field_16.field_2,definition_level_histogram:_.field_3.field_16.field_3},geospatial_statistics:_.field_3.field_17&&{bbox:_.field_3.field_17.field_1&&{xmin:_.field_3.field_17.field_1.field_1,xmax:_.field_3.field_17.field_1.field_2,ymin:_.field_3.field_17.field_1.field_3,ymax:_.field_3.field_17.field_1.field_4,zmin:_.field_3.field_17.field_1.field_5,zmax:_.field_3.field_17.field_1.field_6,mmin:_.field_3.field_17.field_1.field_7,mmax:_.field_3.field_17.field_1.field_8},geospatial_types:_.field_3.field_17.field_2}},offset_index_offset:_.field_4,offset_index_length:_.field_5,column_index_offset:_.field_6,column_index_length:_.field_7,crypto_metadata:_.field_8,encrypted_column_metadata:_.field_9})),total_byte_size:h.field_2,num_rows:h.field_3,sorting_columns:h.field_4?.map(_=>({column_idx:_.field_1,descending:_.field_2,nulls_first:_.field_3})),file_offset:h.field_5,total_compressed_size:h.field_6,ordinal:h.field_7})),m=l.field_5?.map(h=>({key:E(h.field_1),value:E(h.field_2)})),y=E(l.field_6);return n&&Pe(c,m),{version:d,schema:c,num_rows:u,row_groups:p,key_value_metadata:m,created_by:y,metadata_length:o}}function T({schema:e}){return G(e,[])[0]}function ct(e){return e?.field_1?{type:"STRING"}:e?.field_2?{type:"MAP"}:e?.field_3?{type:"LIST"}:e?.field_4?{type:"ENUM"}:e?.field_5?{type:"DECIMAL",scale:e.field_5.field_1,precision:e.field_5.field_2}:e?.field_6?{type:"DATE"}:e?.field_7?{type:"TIME",isAdjustedToUTC:e.field_7.field_1,unit:De(e.field_7.field_2)}:e?.field_8?{type:"TIMESTAMP",isAdjustedToUTC:e.field_8.field_1,unit:De(e.field_8.field_2)}:e?.field_10?{type:"INTEGER",bitWidth:e.field_10.field_1,isSigned:e.field_10.field_2}:e?.field_11?{type:"NULL"}:e?.field_12?{type:"JSON"}:e?.field_13?{type:"BSON"}:e?.field_14?{type:"UUID"}:e?.field_15?{type:"FLOAT16"}:e?.field_16?{type:"VARIANT",specification_version:e.field_16.field_1}:e?.field_17?{type:"GEOMETRY",crs:E(e.field_17.field_1)}:e?.field_18?{type:"GEOGRAPHY",crs:E(e.field_18.field_1),algorithm:ve[e.field_18.field_2]}:e}function De(e){if(e.field_1)return"MILLIS";if(e.field_2)return"MICROS";if(e.field_3)return"NANOS";throw new Error("parquet time unit required")}function ut(e,t,n){return e&&{max:O(e.field_1,t,n),min:O(e.field_2,t,n),null_count:e.field_3,distinct_count:e.field_4,max_value:O(e.field_5,t,n),min_value:O(e.field_6,t,n),is_max_value_exact:e.field_7,is_min_value_exact:e.field_8}}function O(e,t,n){let{type:r,converted_type:i,logical_type:o}=t;if(e===void 0)return e;if(r==="BOOLEAN")return e[0]===1;if(r==="BYTE_ARRAY")return n.stringFromBytes(e);let f=new DataView(e.buffer,e.byteOffset,e.byteLength);return r==="FLOAT"&&f.byteLength===4?f.getFloat32(0,!0):r==="DOUBLE"&&f.byteLength===8?f.getFloat64(0,!0):r==="INT32"&&i==="DATE"?n.dateFromDays(f.getInt32(0,!0)):r==="INT64"&&i==="TIMESTAMP_MILLIS"?n.timestampFromMilliseconds(f.getBigInt64(0,!0)):r==="INT64"&&i==="TIMESTAMP_MICROS"?n.timestampFromMicroseconds(f.getBigInt64(0,!0)):r==="INT64"&&o?.type==="TIMESTAMP"&&o?.unit==="NANOS"?n.timestampFromNanoseconds(f.getBigInt64(0,!0)):r==="INT64"&&o?.type==="TIMESTAMP"&&o?.unit==="MICROS"?n.timestampFromMicroseconds(f.getBigInt64(0,!0)):r==="INT64"&&o?.type==="TIMESTAMP"?n.timestampFromMilliseconds(f.getBigInt64(0,!0)):r==="INT32"&&f.byteLength===4?f.getInt32(0,!0):r==="INT64"&&f.byteLength===8?f.getBigInt64(0,!0):i==="DECIMAL"?fe(e)*10**-(t.scale||0):o?.type==="FLOAT16"?se(e):e}function Be(e,t,n=void 0){n={...D,...n};let r=N(e);return{null_pages:r.field_1,min_values:r.field_2.map(i=>O(i,t,n)),max_values:r.field_3.map(i=>O(i,t,n)),boundary_order:Ie[r.field_4],null_counts:r.field_5,repetition_level_histograms:r.field_6,definition_level_histograms:r.field_7}}function Ue(e){let t=N(e);return{page_locations:t.field_1.map(dt),unencoded_byte_array_data_bytes:t.field_2}}function dt(e){return{offset:e.field_1,compressed_page_size:e.field_2,first_row_index:e.field_3}}function W(e){if(e===void 0)return null;if(typeof e=="bigint")return Number(e);if(Array.isArray(e))return e.map(W);if(e instanceof Uint8Array)return Array.from(e);if(e instanceof Date)return e.toISOString();if(e instanceof Object){let t={};for(let n of Object.keys(e))e[n]!==void 0&&(t[n]=W(e[n]));return t}return e}function $(e,t){for(let r=0;r<t.length;r+=1e4)e.push(...t.slice(r,r+1e4))}function I(e,t){return e===t?!0:e instanceof Uint8Array&&t instanceof Uint8Array?I(Array.from(e),Array.from(t)):!e||!t||typeof e!=typeof t?!1:Array.isArray(e)&&Array.isArray(t)?e.length===t.length&&e.every((n,r)=>I(n,t[r])):typeof e=="object"&&Object.keys(e).length===Object.keys(t).length&&Object.keys(e).every(n=>I(e[n],t[n]))}async function Me(e,t={},n=globalThis.fetch){let r=new AbortController,i=new Headers(t.headers);i.set("Range","bytes=0-0");let o=await n(e,{...t,headers:i,signal:r.signal});if(!o.ok)throw new Error(`fetch with range failed ${o.status}`);if(o.status===206){let f=o.headers.get("Content-Range");if(!f)throw new Error("missing content-range header");let s=f.match(/bytes \d+-\d+\/(\d+)/);if(!s)throw new Error(`invalid content-range header: ${f}`);return parseInt(s[1])}if(o.status===200){let f=o.headers.get("Content-Length");if(r.abort(),f)return parseInt(f)}throw new Error("server does not support range requests and missing content-length")}async function ue(e,t,n){let r=n??globalThis.fetch,i=await r(e,{...t,method:"HEAD"});if(i.status===403)return Me(e,t,r);if(!i.ok)throw new Error(`fetch head failed ${i.status}`);let o=i.headers.get("Content-Length");return o?parseInt(o):Me(e,t,r)}async function $e({url:e,byteLength:t,requestInit:n,fetch:r}){if(!e)throw new Error("missing url");let i=r??globalThis.fetch;t||=await ue(e,n,i);let o,f=n||{};return{byteLength:t,async slice(s,l){if(o)return o.then(u=>u.slice(s,l));let d=new Headers(f.headers),c=l===void 0?"":l-1;d.set("Range",`bytes=${s}-${c}`);let a=await i(e,{...f,headers:d});if(!a.ok||!a.body)throw new Error(`fetch failed ${a.status}`);if(a.status===200)return o=a.arrayBuffer(),o.then(u=>u.slice(s,l));if(a.status===206)return a.arrayBuffer();throw new Error(`fetch received unexpected status code ${a.status}`)}}}function Ce({byteLength:e,slice:t},{minSize:n=ce}={}){if(e<n){let i=t(0,e);return{byteLength:e,async slice(o,f){return(await i).slice(o,f)}}}let r=new Map;return{byteLength:e,slice(i,o){let f=_t(i,o,e),s=r.get(f);if(s)return s;let l=t(i,o);return r.set(f,l),l}}}function _t(e,t,n){if(e<0){if(t!==void 0)throw new Error(`invalid suffix range [${e}, ${t}]`);return n===void 0?`${e},`:`${n+e},${n}`}else if(t!==void 0){if(e>t)throw new Error(`invalid empty range [${e}, ${t}]`);return`${e},${t}`}else return n===void 0?`${e},`:`${e},${n}`}function x(e){if(!e)return[];if(e.length===1)return e[0];let t=[];for(let n of e)$(t,n);return t}function S(e,t={}){return"$and"in t&&Array.isArray(t.$and)?t.$and.every(n=>S(e,n)):"$or"in t&&Array.isArray(t.$or)?t.$or.some(n=>S(e,n)):"$nor"in t&&Array.isArray(t.$nor)?!t.$nor.some(n=>S(e,n)):Object.entries(t).every(([n,r])=>{let i=e[n];return typeof r!="object"||r===null||Array.isArray(r)?I(i,r):Object.entries(r||{}).every(([o,f])=>o==="$gt"?i>f:o==="$gte"?i>=f:o==="$lt"?i<f:o==="$lte"?i<=f:o==="$eq"?I(i,f):o==="$ne"?!I(i,f):o==="$in"?Array.isArray(f)&&f.includes(i):o==="$nin"?Array.isArray(f)&&!f.includes(i):o==="$not"?!S({[n]:i},{[n]:f}):!0)})}function H(e,t,n){if(!e)return!1;if("$and"in e&&Array.isArray(e.$and))return e.$and.some(r=>H(r,t,n));if("$or"in e&&Array.isArray(e.$or))return e.$or.every(r=>H(r,t,n));if("$nor"in e&&Array.isArray(e.$nor))return!1;for(let[r,i]of Object.entries(e)){let o=n.indexOf(r);if(o===-1)continue;let s=t.columns[o].meta_data?.statistics;if(!s)continue;let{min:l,max:d,min_value:c,max_value:a}=s,u=c!==void 0?c:l,p=a!==void 0?a:d;if(!(u===void 0||p===void 0)){for(let[m,y]of Object.entries(i||{}))if(m==="$gt"&&p<=y||m==="$gte"&&p<y||m==="$lt"&&u>=y||m==="$lte"&&u>y||m==="$eq"&&(y<u||y>p)||m==="$ne"&&I(u,p)&&I(u,y)||m==="$in"&&Array.isArray(y)&&y.every(h=>h<u||h>p)||m==="$nin"&&Array.isArray(y)&&I(u,p)&&y.includes(u))return!0}}return!1}var pt=1<<25;function Fe({metadata:e,rowStart:t=0,rowEnd:n=1/0,columns:r,filter:i}){if(!e)throw new Error("parquetPlan requires metadata");let o=[],f=[],s=Le(T(e)),l=0;for(let d of e.row_groups){let c=Number(d.num_rows),a=l+c;if(c>0&&a>t&&l<n&&!H(i,d,s)){let u=[];for(let{file_path:h,meta_data:_}of d.columns){if(h)throw new Error("parquet file_path not supported");if(!_)throw new Error("parquet column metadata is undefined");(!r||r.includes(_.path_in_schema[0]))&&u.push(de(_))}let p=Math.max(t-l,0),m=Math.min(n-l,c);o.push({ranges:u,rowGroup:d,groupStart:l,groupRows:c,selectStart:p,selectEnd:m});let y=u[u.length-1]?.endByte-u[0]?.startByte;if(!r&&y<pt)f.push({startByte:u[0].startByte,endByte:u[u.length-1].endByte});else if(u.length)$(f,u);else if(r?.length)throw new Error(`parquet columns not found: ${r.join(", ")}`)}l=a}return isFinite(n)||(n=l),{metadata:e,rowStart:t,rowEnd:n,columns:r,fetches:f,groups:o}}function de({dictionary_page_offset:e,data_page_offset:t,total_compressed_size:n}){let r=e||t;return{startByte:Number(r),endByte:Number(r+n)}}function qe(e,{fetches:t}){let n=t.map(({startByte:r,endByte:i})=>e.slice(r,i));return{byteLength:e.byteLength,slice(r,i=e.byteLength){let o=t.findIndex(({startByte:f,endByte:s})=>f<=r&&i<=s);if(o<0)throw new Error(`no prefetch for range [${r}, ${i}]`);if(t[o].startByte!==r||t[o].endByte!==i){let f=r-t[o].startByte,s=i-t[o].startByte;return n[o]instanceof Promise?n[o].then(l=>l.slice(f,s)):n[o].slice(f,s)}else return n[o]}}}function _e(e,t,n,r,i){let o=t?.length||n.length;if(!o)return r;let f=M(i),s=i.map(({element:m})=>m.repetition_type),l=0,d=[e],c=e,a=0,u=0,p=0;if(n[0])for(;a<s.length-2&&p<n[0];)a++,s[a]!=="REQUIRED"&&(c=c.at(-1),d.push(c),u++),s[a]==="REPEATED"&&p++;for(let m=0;m<o;m++){let y=t?.length?t[m]:f,h=n[m];for(;a&&(h<p||s[a]!=="REPEATED");)s[a]!=="REQUIRED"&&(d.pop(),u--),s[a]==="REPEATED"&&p--,a--;for(c=d.at(-1);(a<s.length-2||s[a+1]==="REPEATED")&&(u<y||s[a+1]==="REQUIRED");){if(a++,s[a]!=="REQUIRED"){let _=[];c.push(_),c=_,d.push(_),u++}s[a]==="REPEATED"&&p++}y===f?c.push(r[l++]):a===s.length-2?c.push(null):c.push([])}if(!e.length)for(let m=0;m<f;m++){let y=[];c.push(y),c=y}return e}function B(e,t,n=0){let r=t.path.join("."),i=t.element.repetition_type==="OPTIONAL",o=i?n+1:n;if(xe(t)){let f=t.children[0],s=o;f.children.length===1&&(f=f.children[0],s++),B(e,f,s);let l=f.path.join("."),d=e.get(l);if(!d)throw new Error("parquet list column missing values");i&&Z(d,n),e.set(r,d),e.delete(l);return}if(Ne(t)){let f=t.children[0].element.name;B(e,t.children[0].children[0],o+1),B(e,t.children[0].children[1],o+1);let s=e.get(`${r}.${f}.key`),l=e.get(`${r}.${f}.value`);if(!s)throw new Error("parquet map column missing keys");if(!l)throw new Error("parquet map column missing values");if(s.length!==l.length)throw new Error("parquet map column key/value length mismatch");let d=Ye(s,l,o);i&&Z(d,n),e.delete(`${r}.${f}.key`),e.delete(`${r}.${f}.value`),e.set(r,d);return}if(t.children.length){let f=t.element.repetition_type==="REQUIRED"?n:n+1,s={};for(let d of t.children){B(e,d,f);let c=e.get(d.path.join("."));if(!c)throw new Error("parquet struct missing child data");s[d.element.name]=c}for(let d of t.children)e.delete(d.path.join("."));let l=ke(s,f);i&&Z(l,n),e.set(r,l)}}function Z(e,t){for(let n=0;n<e.length;n++)t?Z(e[n],t-1):e[n]=e[n][0]}function Ye(e,t,n){let r=[];for(let i=0;i<e.length;i++)if(n)r.push(Ye(e[i],t[i],n-1));else if(e[i]){let o={};for(let f=0;f<e[i].length;f++){let s=t[i][f];o[e[i][f]]=s===void 0?null:s}r.push(o)}else r.push(void 0);return r}function ke(e,t){let n=Object.keys(e),r=e[n[0]]?.length,i=[];for(let o=0;o<r;o++){let f={};for(let s of n){if(e[s].length!==r)throw new Error("parquet struct parsing error");f[s]=e[s][o]}t?i.push(ke(f,t-1)):i.push(f)}return i}function U(e,t,n){let r=n instanceof Int32Array,i=b(e),o=b(e);b(e);let f=j(e),s=0;n[s++]=r?Number(f):f;let l=i/o;for(;s<t;){let d=j(e),c=new Uint8Array(o);for(let a=0;a<o;a++)c[a]=e.view.getUint8(e.offset++);for(let a=0;a<o&&s<t;a++){let u=BigInt(c[a]);if(u){let p=0n,m=l,y=(1n<<u)-1n;for(;m&&s<t;){let h=BigInt(e.view.getUint8(e.offset))>>p&y;for(p+=u;p>=8;)p-=8n,e.offset++,p&&(h|=BigInt(e.view.getUint8(e.offset))<<u-p&y);let _=d+h;f+=_,n[s++]=r?Number(f):f,m--}m&&(e.offset+=Math.ceil((m*Number(u)+Number(p))/8))}else for(let p=0;p<l&&s<t;p++)f+=d,n[s++]=r?Number(f):f}}}function pe(e,t,n){let r=new Int32Array(t);U(e,t,r);for(let i=0;i<t;i++)n[i]=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,r[i]),e.offset+=r[i]}function Ge(e,t,n){let r=new Int32Array(t);U(e,t,r);let i=new Int32Array(t);U(e,t,i);for(let o=0;o<t;o++){let f=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,i[o]);r[o]?(n[o]=new Uint8Array(r[o]+i[o]),n[o].set(n[o-1].subarray(0,r[o])),n[o].set(f,r[o])):n[o]=f,e.offset+=i[o]}}function C(e){return 32-Math.clz32(e)}function R(e,t,n,r){r===void 0&&(r=e.view.getUint32(e.offset,!0),e.offset+=4);let i=e.offset,o=0;for(;o<n.length;){let f=b(e);if(f&1)o=ht(e,f,t,n,o);else{let s=f>>>1;mt(e,s,t,n,o),o+=s}}e.offset=i+r}function mt(e,t,n,r,i){let o=n+7>>3,f=0;for(let s=0;s<o;s++)f|=e.view.getUint8(e.offset++)<<(s<<3);for(let s=0;s<t;s++)r[i+s]=f}function ht(e,t,n,r,i){let o=t>>1<<3,f=(1<<n)-1,s=0;if(e.offset<e.view.byteLength)s=e.view.getUint8(e.offset++);else if(f)throw new Error(`parquet bitpack offset ${e.offset} out of range`);let l=8,d=0;for(;o;)d>8?(d-=8,l-=8,s>>>=8):l-d<n?(s|=e.view.getUint8(e.offset)<<l,e.offset++,l+=8):(i<r.length&&(r[i++]=s>>d&f),o--,d+=n);return i}function me(e,t,n,r){let i=yt(n,r),o=new Uint8Array(t*i);for(let f=0;f<i;f++)for(let s=0;s<t;s++)o[s*i+f]=e.view.getUint8(e.offset++);if(n==="FLOAT")return new Float32Array(o.buffer);if(n==="DOUBLE")return new Float64Array(o.buffer);if(n==="INT32")return new Int32Array(o.buffer);if(n==="INT64")return new BigInt64Array(o.buffer);if(n==="FIXED_LEN_BYTE_ARRAY"){let f=new Array(t);for(let s=0;s<t;s++)f[s]=o.subarray(s*i,(s+1)*i);return f}throw new Error(`parquet byte_stream_split unsupported type: ${n}`)}function yt(e,t){switch(e){case"INT32":case"FLOAT":return 4;case"INT64":case"DOUBLE":return 8;case"FIXED_LEN_BYTE_ARRAY":if(!t)throw new Error("parquet byteWidth missing type_length");return t;default:throw new Error(`parquet unsupported type: ${e}`)}}function F(e,t,n,r){if(n===0)return[];if(t==="BOOLEAN")return gt(e,n);if(t==="INT32")return wt(e,n);if(t==="INT64")return At(e,n);if(t==="INT96")return Et(e,n);if(t==="FLOAT")return It(e,n);if(t==="DOUBLE")return vt(e,n);if(t==="BYTE_ARRAY")return bt(e,n);if(t==="FIXED_LEN_BYTE_ARRAY"){if(!r)throw new Error("parquet missing fixed length");return Tt(e,n,r)}else throw new Error(`parquet unhandled type: ${t}`)}function gt(e,t){let n=new Array(t);for(let r=0;r<t;r++){let i=e.offset+(r/8|0),o=r%8,f=e.view.getUint8(i);n[r]=(f&1<<o)!==0}return e.offset+=Math.ceil(t/8),n}function wt(e,t){let n=(e.view.byteOffset+e.offset)%4?new Int32Array(Q(e.view.buffer,e.view.byteOffset+e.offset,t*4)):new Int32Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=t*4,n}function At(e,t){let n=(e.view.byteOffset+e.offset)%8?new BigInt64Array(Q(e.view.buffer,e.view.byteOffset+e.offset,t*8)):new BigInt64Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=t*8,n}function Et(e,t){let n=new Array(t);for(let r=0;r<t;r++){let i=e.view.getBigInt64(e.offset+r*12,!0),o=e.view.getInt32(e.offset+r*12+8,!0);n[r]=BigInt(o)<<64n|i}return e.offset+=t*12,n}function It(e,t){let n=(e.view.byteOffset+e.offset)%4?new Float32Array(Q(e.view.buffer,e.view.byteOffset+e.offset,t*4)):new Float32Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=t*4,n}function vt(e,t){let n=(e.view.byteOffset+e.offset)%8?new Float64Array(Q(e.view.buffer,e.view.byteOffset+e.offset,t*8)):new Float64Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=t*8,n}function bt(e,t){let n=new Array(t);for(let r=0;r<t;r++){let i=e.view.getUint32(e.offset,!0);e.offset+=4,n[r]=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,i),e.offset+=i}return n}function Tt(e,t,n){let r=new Array(t);for(let i=0;i<t;i++)r[i]=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,n),e.offset+=n;return r}function Q(e,t,n){let r=new ArrayBuffer(n);return new Uint8Array(r).set(new Uint8Array(e,t,n)),r}var Rt=[0,255,65535,16777215,4294967295];function Ve(e,t,n,r,i){for(let o=0;o<i;o++)n[r+o]=e[t+o]}function K(e,t){let n=e.byteLength,r=t.byteLength,i=0,o=0;for(;i<n;){let f=e[i];if(i++,f<128)break}if(r&&i>=n)throw new Error("invalid snappy length header");for(;i<n;){let f=e[i],s=0;if(i++,i>=n)throw new Error("missing eof marker");if((f&3)===0){let l=(f>>>2)+1;if(l>60){if(i+3>=n)throw new Error("snappy error literal pos + 3 >= inputLength");let d=l-60;l=e[i]+(e[i+1]<<8)+(e[i+2]<<16)+(e[i+3]<<24),l=(l&Rt[d])+1,i+=d}if(i+l>n)throw new Error("snappy error literal exceeds input length");Ve(e,i,t,o,l),i+=l,o+=l}else{let l=0;switch(f&3){case 1:s=(f>>>2&7)+4,l=e[i]+(f>>>5<<8),i++;break;case 2:if(n<=i+1)throw new Error("snappy error end of input");s=(f>>>2)+1,l=e[i]+(e[i+1]<<8),i+=2;break;case 3:if(n<=i+3)throw new Error("snappy error end of input");s=(f>>>2)+1,l=e[i]+(e[i+1]<<8)+(e[i+2]<<16)+(e[i+3]<<24),i+=4;break;default:break}if(l===0||isNaN(l))throw new Error(`invalid offset ${l} pos ${i} inputLength ${n}`);if(l>o)throw new Error("cannot copy from before start of buffer");Ve(t,o-l,t,o,s),o+=s}}if(o!==r)throw new Error("premature end of input")}function je(e,t,{type:n,element:r,schemaPath:i}){let o=new DataView(e.buffer,e.byteOffset,e.byteLength),f={view:o,offset:0},s,l=Lt(f,t,i),{definitionLevels:d,numNulls:c}=xt(f,t,i),a=t.num_values-c;if(t.encoding==="PLAIN")s=F(f,n,a,r.type_length);else if(t.encoding==="PLAIN_DICTIONARY"||t.encoding==="RLE_DICTIONARY"||t.encoding==="RLE"){let u=n==="BOOLEAN"?1:o.getUint8(f.offset++);u?(s=new Array(a),n==="BOOLEAN"?(R(f,u,s),s=s.map(p=>!!p)):R(f,u,s,o.byteLength-f.offset)):s=new Uint8Array(a)}else if(t.encoding==="BYTE_STREAM_SPLIT")s=me(f,a,n,r.type_length);else if(t.encoding==="DELTA_BINARY_PACKED")s=n==="INT32"?new Int32Array(a):new BigInt64Array(a),U(f,a,s);else if(t.encoding==="DELTA_LENGTH_BYTE_ARRAY")s=new Array(a),pe(f,a,s);else throw new Error(`parquet unsupported encoding: ${t.encoding}`);return{definitionLevels:d,repetitionLevels:l,dataPage:s}}function Lt(e,t,n){if(n.length>1){let r=le(n);if(r){let i=new Array(t.num_values);return R(e,C(r),i),i}}return[]}function xt(e,t,n){let r=M(n);if(!r)return{definitionLevels:[],numNulls:0};let i=new Array(t.num_values);R(e,C(r),i);let o=t.num_values;for(let f of i)f===r&&o--;return o===0&&(i.length=0),{definitionLevels:i,numNulls:o}}function J(e,t,n,r){let i,o=r?.[n];if(n==="UNCOMPRESSED")i=e;else if(o)i=o(e,t);else if(n==="SNAPPY")i=new Uint8Array(t),K(e,i);else throw new Error(`parquet unsupported compression codec: ${n}`);if(i?.length!==t)throw new Error(`parquet decompressed page length ${i?.length} does not match header ${t}`);return i}function ze(e,t,n){let i={view:new DataView(e.buffer,e.byteOffset,e.byteLength),offset:0},{type:o,element:f,schemaPath:s,codec:l,compressors:d}=n,c=t.data_page_header_v2;if(!c)throw new Error("parquet data page header v2 is undefined");let a=Nt(i,c,s);i.offset=c.repetition_levels_byte_length;let u=Ot(i,c,s),p=t.uncompressed_page_size-c.definition_levels_byte_length-c.repetition_levels_byte_length,m=e.subarray(i.offset);c.is_compressed!==!1&&(m=J(m,p,l,d));let y=new DataView(m.buffer,m.byteOffset,m.byteLength),h={view:y,offset:0},_,g=c.num_values-c.num_nulls;if(c.encoding==="PLAIN")_=F(h,o,g,f.type_length);else if(c.encoding==="RLE")_=new Array(g),R(h,1,_),_=_.map(w=>!!w);else if(c.encoding==="PLAIN_DICTIONARY"||c.encoding==="RLE_DICTIONARY"){let w=y.getUint8(h.offset++);_=new Array(g),R(h,w,_,p-1)}else if(c.encoding==="DELTA_BINARY_PACKED")_=o==="INT32"?new Int32Array(g):new BigInt64Array(g),U(h,g,_);else if(c.encoding==="DELTA_LENGTH_BYTE_ARRAY")_=new Array(g),pe(h,g,_);else if(c.encoding==="DELTA_BYTE_ARRAY")_=new Array(g),Ge(h,g,_);else if(c.encoding==="BYTE_STREAM_SPLIT")_=me(i,g,o,f.type_length);else throw new Error(`parquet unsupported encoding: ${c.encoding}`);return{definitionLevels:u,repetitionLevels:a,dataPage:_}}function Nt(e,t,n){let r=le(n);if(!r)return[];let i=new Array(t.num_values);return R(e,C(r),i,t.repetition_levels_byte_length),i}function Ot(e,t,n){let r=M(n);if(r){let i=new Array(t.num_values);return R(e,C(r),i,t.definition_levels_byte_length),i}}function He(e,{groupStart:t,selectStart:n,selectEnd:r},i,o){let{columnName:f,schemaPath:s}=i,l=ae(s),d=[],c,a,u=0,p=o&&(()=>{a&&o({columnName:f,columnData:a,rowStart:t+u-a.length,rowEnd:t+u})});for(;(l?u<r:e.offset<e.view.byteLength-1)&&!(e.offset>=e.view.byteLength-1);){let m=St(e);if(m.type==="DICTIONARY_PAGE")c=We(e,m,i,c,void 0,0),c=oe(c,i);else{let y=a?.length||0,h=We(e,m,i,c,a,n-u);a===h?u+=h.length-y:(p?.(),d.push(h),u+=h.length,a=h)}}return p?.(),u>r&&a&&(d[d.length-1]=a.slice(0,r-(u-a.length))),d}function We(e,t,n,r,i,o){let{type:f,element:s,schemaPath:l,codec:d,compressors:c}=n,a=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,t.compressed_page_size);if(e.offset+=t.compressed_page_size,t.type==="DATA_PAGE"){let u=t.data_page_header;if(!u)throw new Error("parquet data page header is undefined");if(o>u.num_values&&ae(l))return new Array(u.num_values);let p=J(a,Number(t.uncompressed_page_size),d,c),{definitionLevels:m,repetitionLevels:y,dataPage:h}=je(p,u,n),_=ie(h,r,u.encoding,n);if(y.length||m?.length){let g=Array.isArray(i)?i:[];return _e(g,m,y,_,l)}else{for(let g=2;g<l.length;g++)l[g].element.repetition_type!=="REQUIRED"&&(_=Array.from(_,w=>[w]));return _}}else if(t.type==="DATA_PAGE_V2"){let u=t.data_page_header_v2;if(!u)throw new Error("parquet data page header v2 is undefined");if(o>u.num_rows)return new Array(u.num_values);let{definitionLevels:p,repetitionLevels:m,dataPage:y}=ze(a,t,n),h=ie(y,r,u.encoding,n),_=Array.isArray(i)?i:[];return _e(_,p,m,h,l)}else if(t.type==="DICTIONARY_PAGE"){let u=t.dictionary_page_header;if(!u)throw new Error("parquet dictionary page header is undefined");let p=J(a,Number(t.uncompressed_page_size),d,c),m={view:new DataView(p.buffer,p.byteOffset,p.byteLength),offset:0};return F(m,f,u.num_values,s.type_length)}else throw new Error(`parquet unsupported page type: ${t.type}`)}function St(e){let t=N(e),n=q[t.field_1],r=t.field_2,i=t.field_3,o=t.field_4,f=t.field_5&&{num_values:t.field_5.field_1,encoding:v[t.field_5.field_2],definition_level_encoding:v[t.field_5.field_3],repetition_level_encoding:v[t.field_5.field_4],statistics:t.field_5.field_5&&{max:t.field_5.field_5.field_1,min:t.field_5.field_5.field_2,null_count:t.field_5.field_5.field_3,distinct_count:t.field_5.field_5.field_4,max_value:t.field_5.field_5.field_5,min_value:t.field_5.field_5.field_6}},s=t.field_6,l=t.field_7&&{num_values:t.field_7.field_1,encoding:v[t.field_7.field_2],is_sorted:t.field_7.field_3},d=t.field_8&&{num_values:t.field_8.field_1,num_nulls:t.field_8.field_2,num_rows:t.field_8.field_3,encoding:v[t.field_8.field_4],definition_levels_byte_length:t.field_8.field_5,repetition_levels_byte_length:t.field_8.field_6,is_compressed:t.field_8.field_7===void 0?!0:t.field_8.field_7,statistics:t.field_8.field_8};return{type:n,uncompressed_page_size:r,compressed_page_size:i,crc:o,data_page_header:f,index_page_header:s,dictionary_page_header:l,data_page_header_v2:d}}function Ze(e,{metadata:t,columns:n},r){let{file:i,compressors:o,utf8:f}=e,s=[],l={...D,...e.parsers};for(let{file_path:d,meta_data:c}of r.rowGroup.columns){if(d)throw new Error("parquet file_path not supported");if(!c)throw new Error("parquet column metadata is undefined");let a=c.path_in_schema[0];if(n&&!n.includes(a))continue;let{startByte:u,endByte:p}=de(c),m=p-u;if(m>1<<30){console.warn(`parquet skipping huge column "${c.path_in_schema}" ${m} bytes`);continue}let y=Promise.resolve(i.slice(u,p));s.push({pathInSchema:c.path_in_schema,data:y.then(h=>{let _=G(t.schema,c.path_in_schema),g={view:new DataView(h),offset:0},et={columnName:c.path_in_schema.join("."),type:c.type,element:_[_.length-1].element,schemaPath:_,codec:c.codec,parsers:l,compressors:o,utf8:f};return He(g,r,et,e.onPage)})})}return{groupStart:r.groupStart,groupRows:r.groupRows,asyncColumns:s}}async function he({asyncColumns:e},t,n,r,i){let o=await Promise.all(e.map(({data:a})=>a.then(x))),f=e.map(a=>a.pathInSchema[0]).filter(a=>!r||r.includes(a)),s=r??f,l=s.map(a=>e.findIndex(u=>u.pathInSchema[0]===a)),d=n-t;if(i==="object"){let a=new Array(d);for(let u=0;u<d;u++){let p=t+u,m={};for(let y=0;y<e.length;y++)m[e[y].pathInSchema[0]]=o[y][p];a[u]=m}return a}let c=new Array(d);for(let a=0;a<d;a++){let u=t+a,p=new Array(e.length);for(let m=0;m<s.length;m++)l[m]>=0&&(p[m]=o[l[m]][u]);c[a]=p}return c}function ye(e,t){let{asyncColumns:n}=e,r=[];for(let i of t.children)if(i.children.length){let o=n.filter(l=>l.pathInSchema[0]===i.element.name);if(!o.length)continue;let f=new Map,s=Promise.all(o.map(l=>l.data.then(d=>{f.set(l.pathInSchema.join("."),x(d))}))).then(()=>{B(f,i);let l=f.get(i.path.join("."));if(!l)throw new Error("parquet column data not assembled");return[l]});r.push({pathInSchema:i.path,data:s})}else{let o=n.find(f=>f.pathInSchema[0]===i.element.name);o&&r.push(o)}return{...e,asyncColumns:r}}async function ge(e){e.metadata??=await L(e.file,e);let t=Qe(e),{rowStart:n=0,rowEnd:r,columns:i,onChunk:o,onComplete:f,rowFormat:s}=e;if(!f&&!o){for(let{asyncColumns:c}of t)for(let{data:a}of c)await a;return}let l=T(e.metadata),d=t.map(c=>ye(c,l));if(o)for(let c of d)for(let a of c.asyncColumns)a.data.then(u=>{let p=c.groupStart;for(let m of u)o({columnName:a.pathInSchema[0],columnData:m,rowStart:p,rowEnd:p+m.length}),p+=m.length});if(f){let c=[];for(let a of d){let u=Math.max(n-a.groupStart,0),p=Math.min((r??1/0)-a.groupStart,a.groupRows),m=s==="object"?await he(a,u,p,i,"object"):await he(a,u,p,i,"array");$(c,m)}f(c)}else for(let{asyncColumns:c}of d)for(let{data:a}of c)await a}function Qe(e){if(!e.metadata)throw new Error("parquet requires metadata");let t=Fe(e);return e.file=qe(e.file,t),t.groups.map(n=>Ze(e,t,n))}async function Ke(e){if(e.columns?.length!==1)throw new Error("parquetReadColumn expected columns: [columnName]");e.metadata??=await L(e.file,e);let t=Qe(e),n=T(e.metadata),r=t.map(o=>ye(o,n)),i=[];for(let o of r)i.push(x(await o.asyncColumns[0].data));return x(i)}function P(e){return new Promise((t,n)=>{ge({...e,rowFormat:"object",onComplete:t}).catch(n)})}async function Xe(e){if(!e.file||!(e.file.byteLength>=0))throw new Error("parquet expected AsyncBuffer");e.metadata??=await L(e.file,e);let{metadata:t,rowStart:n=0,columns:r,orderBy:i,filter:o}=e;if(n<0)throw new Error("parquet rowStart must be positive");let f=e.rowEnd??Number(t.num_rows),s=X(o),l=T(e.metadata).children.map(u=>u.element.name),d=s.filter(u=>!l.includes(u));if(d.length)throw new Error(`parquet filter columns not found: ${d.join(", ")}`);if(i&&!l.includes(i))throw new Error(`parquet orderBy column not found: ${i}`);let c=r?l.filter(u=>r.includes(u)||s.includes(u)||u===i):void 0,a=r&&c?r.length<c.length:!1;if(o&&!i&&f<t.num_rows){let u=new Array,p=0;for(let m of t.row_groups){let y=p+Number(m.num_rows),h=await P({...e,rowStart:p,rowEnd:y,columns:c});for(let _ of h)if(S(_,o)){if(a&&c)for(let g of c)r&&!r.includes(g)&&delete _[g];u.push(_)}if(u.length>=f)break;p=y}return u.slice(n,f)}else if(o){let u=await P({...e,rowStart:void 0,rowEnd:void 0,columns:c});i&&u.sort((m,y)=>Je(m[i],y[i]));let p=new Array;for(let m of u)if(S(m,o)){if(a&&c)for(let y of c)r&&!r.includes(y)&&delete m[y];p.push(m)}return p.slice(n,f)}else if(typeof i=="string"){let u=await Ke({...e,rowStart:void 0,rowEnd:void 0,columns:[i]}),p=Array.from(u,(h,_)=>_).sort((h,_)=>Je(u[h],u[_])).slice(n,f),m=await Pt({...e,rows:p});return p.map(h=>m[h])}else return await P(e)}async function Pt(e){let{file:t,rows:n}=e;e.metadata||=await L(t,e);let{row_groups:r}=e.metadata,i=Array(r.length).fill(!1),o=0,f=r.map(c=>o+=Number(c.num_rows));for(let c of n){let a=f.findIndex(u=>c<u);i[a]=!0}let s=[],l;o=0;for(let c=0;c<i.length;c++){let a=o+Number(r[c].num_rows);i[c]?l===void 0&&(l=o):l!==void 0&&(s.push([l,a]),l=void 0),o=a}l!==void 0&&s.push([l,o]);let d=new Array(Number(e.metadata.num_rows));for(let[c,a]of s){let u=await P({...e,rowStart:c,rowEnd:a});for(let p=c;p<a;p++)d[p]={__index__:p,...u[p-c]}}return d}function Je(e,t){return e<t?-1:e>t?1:0}function X(e){if(!e)return[];let t=[];return"$and"in e&&Array.isArray(e.$and)?t.push(...e.$and.flatMap(X)):"$or"in e&&Array.isArray(e.$or)?t.push(...e.$or.flatMap(X)):"$nor"in e&&Array.isArray(e.$nor)?t.push(...e.$nor.flatMap(X)):t.push(...Object.keys(e)),t}return ft(Dt);})();
